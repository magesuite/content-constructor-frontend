<?php
/** @var \MageSuite\ContentConstructorFrontend\Model\Component\ImageTeaser $viewModel */
$viewModel = $block->getViewModel();
$imageTeaserData = $block->getImageTeaserData();
$imageTypeHelper = $this->helper(\MageSuite\ThemeHelpers\Helper\ImageType::class);
$slide = $block->getSlide();
$isSvg = $slide->isSvg();

/**
 * Image properties with support for conditional lazy loading.
 */

$origImageSrc = $block->escapeUrl($slide->getSrc());
$hasImage = !empty($origImageSrc);
$placeholderImageSrc = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
$imageSrcset = $slide->getSrcSet();

if (empty($imageSrcset) || $isSvg) {
    $imageSrcset = $origImageSrc;
}

$imageAlt = $viewModel->replaceHtmlTagsWithWhiteSpaces((string)$slide->getAlt());
$imageSizes = $isSvg ? '' : $slide->getSizes();
$isSlider = $block->getIsSlider();
$isSliderMobile = $block->getIsSliderMobile();
$fetchPriority = $block->getFetchPriority();
$lazyLoad = $block->getLazyLoad();
$eagerLoad = $block->getEagerLoad();

/**
 * Aspect ratio and sizing
 */
$aspectRatio = $block->getAspectRatio();
$imageWidth = $slide->getWidth();
$imageHeight = $slide->getHeight();

/**
 * Contrast optimizers
 */
$contrastOptimizers = $slide->getOptimizers();
$mirrorImage = $contrastOptimizers['mirror_image'] ?? null;

/**
 * WebP support
 */
$isWebpSupported = $imageTypeHelper->supportsWebp($origImageSrc);
$imageMimeType = $imageTypeHelper->getMimeType($origImageSrc);
if ($isWebpSupported) {
    $imageWebpSrcSet = $slide->getWebpSrcSet();
}

/**
 * Video Teaser
 */
$videoTeaserData = $slide->getVideo();
$hasVideoTeaser = !empty($videoTeaserData['url']) && !empty($videoTeaserData['type']);

/**
 * Conditional lazy loading
 */
$isLazyLoaded = $eagerLoad ? false : $lazyLoad;
?>

<?php if ($hasImage): ?>
    <picture class="cs-image-teaser__picture"<?php if($aspectRatio): ?> style="aspect-ratio: <?= $aspectRatio ?>"<?php endif ?>>
        <?php if($hasVideoTeaser): ?>
            <?= $this->getLayout()
                ->createBlock(\MageSuite\ContentConstructorFrontend\Block\Component\ImageTeaser\VideoTeaser::class)
                ->setImageTeaserData($imageTeaserData)
                ->setSlide($slide)
                ->setVideoTeaserData($videoTeaserData)
                ->toHtml();
            ?>
        <?php endif; ?>

        <?php if ($isWebpSupported): ?>
            <source
                type="image/webp"
                srcset="<?= $imageWebpSrcSet ?>"
                <?php if ($imageSizes): ?>
                    sizes="<?= $imageSizes ?>"
                <?php endif; ?>
                <?php if ($imageWidth): ?>
                    width="<?= $imageWidth ?>"
                <?php endif; ?>
                <?php if ($imageHeight): ?>
                    height="<?= $imageHeight ?>"
                <?php endif; ?>
            >
        <?php endif; ?>
        <source
             <?php if ($isLazyLoaded): ?>
                srcset="<?= $placeholderImageSrc ?>"
                data-srcset="<?= $imageSrcset ?>"
            <?php else: ?>
                srcset="<?= $imageSrcset ?>"
            <?php endif; ?>

            type="<?= $imageMimeType ?>"
            <?php if ($imageSizes): ?>
                sizes="<?= $imageSizes ?>"
            <?php endif; ?>
            <?php if ($imageWidth): ?>
                width="<?= $imageWidth ?>"
            <?php endif; ?>
            <?php if ($imageHeight): ?>
                height="<?= $imageHeight ?>"
            <?php endif; ?>
        >
        <img
            class="cs-image-teaser__image<?= $mirrorImage ? ' cs-image-teaser__image--mirror' : '' ?><?= $isLazyLoaded ? ' lazyload' : '' ?>"
            alt="<?= $imageAlt ?>"
            
            <?php if ($isLazyLoaded): ?>
                src="<?= $placeholderImageSrc ?>"
                data-src="<?= $origImageSrc ?>"
                data-srcset="<?= $imageSrcset ?>"
            <?php else: ?>
                src="<?= $origImageSrc ?>"
                srcset="<?= $imageSrcset ?>"
            <?php endif; ?>
            <?php if ($imageSizes): ?>
                sizes="<?= $imageSizes ?>"
            <?php endif; ?>
            <?php if ($imageWidth): ?>
                width="<?= $imageWidth ?>"
            <?php endif; ?>
            <?php if ($imageHeight): ?>
                height="<?= $imageHeight ?>"
            <?php endif; ?>
            <?php if ($fetchPriority): ?>
                fetchpriority="high"
            <?php endif; ?>
            <?php if ($eagerLoad): ?>
                loading="eager"
            <?php endif; ?>
        >
    </picture>
<?php endif; ?>
